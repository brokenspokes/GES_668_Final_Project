<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>readme</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="README_files/libs/clipboard/clipboard.min.js"></script>
<script src="README_files/libs/quarto-html/quarto.js"></script>
<script src="README_files/libs/quarto-html/popper.min.js"></script>
<script src="README_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="README_files/libs/quarto-html/anchor.min.js"></script>
<link href="README_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="README_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="README_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="README_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="README_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="property-assesments-and-sale-in-baltimore" class="level1">
<h1>Property Assesments and Sale in Baltimore</h1>
<p>An analysis of sales of real property over the last five years in Baltimore, compared with assessed prices. This project aims to determine whether there is a systematic issue with assessments in the state of maryland assigning low values to vacant homes and property.</p>
<section id="data-sources" class="level2">
<h2 class="anchored" data-anchor-id="data-sources">Data Sources</h2>
<p>Most of the data used in this project is too large to be uploaded to github.All of the data except for one table is publicly available with both an API endpoint and the ability to download through an open data portal. I will provide both for all of those where it is available in addition to a public repository link where the extracts used in these analyses are available.</p>
<section id="baltimore-real-property-information-cc-3.0" class="level3">
<h3 class="anchored" data-anchor-id="baltimore-real-property-information-cc-3.0">Baltimore Real Property Information (CC 3.0)</h3>
<p><a href="https://geodata.baltimorecity.gov/egis/rest/services/CityView/Realproperty_OB/FeatureServer/0">API Endpoint</a></p>
<p><a href="https://data.baltimorecity.gov/datasets/baltimore::real-property-information-2/about">Open Data Portal</a></p>
<p><a href="https://doi.org/10.5281/zenodo.14498393">My extract</a></p>
</section>
<section id="baltimore-vacant-building-notices-cc-3.0" class="level3">
<h3 class="anchored" data-anchor-id="baltimore-vacant-building-notices-cc-3.0">Baltimore Vacant Building Notices (CC 3.0)</h3>
<p>This is not available through the Baltimore Open Data portal.</p>
<p><a href="https://doi.org/10.5281/zenodo.14497481">Available extract</a></p>
</section>
<section id="maryland-real-property-information-public-domain" class="level3">
<h3 class="anchored" data-anchor-id="maryland-real-property-information-public-domain">Maryland Real Property Information (Public Domain)</h3>
<p><a href="https://geodata.md.gov/imap/rest/services/PlanningCadastre/MD_ParcelBoundaries/MapServer/0">API Endpoint</a></p>
<p><a href="https://opendata.maryland.gov/Business-and-Economy/Maryland-Real-Property-Assessments_Hidden-Property/ed4q-f8tm/about_data">Open Data Portal</a></p>
<p><a href="https://doi.org/10.5281/zenodo.14498401">My extract</a></p>
</section>
<section id="maryland-cama-data" class="level3">
<h3 class="anchored" data-anchor-id="maryland-cama-data">Maryland CAMA Data</h3>
<p><a href="https://geodata.md.gov/imap/rest/services/PlanningCadastre/MD_ComputerAssistedMassAppraisal/MapServer">API Endpoint</a></p>
<p><a href="https://doi.org/10.5281/zenodo.14498436">My extract</a></p>
</section>
<section id="baltimore-neighborhoods" class="level3">
<h3 class="anchored" data-anchor-id="baltimore-neighborhoods">Baltimore Neighborhoods</h3>
<p><a href="https://data.baltimorecity.gov/datasets/baltimore::neighborhood-statistical-area-nsa-boundaries/about">Open Data Portal</a></p>
</section>
</section>
<section id="analysis-scripts" class="level2">
<h2 class="anchored" data-anchor-id="analysis-scripts">Analysis Scripts</h2>
<p>The Analysis scripts are in the “R” folder and are numbered in the order described in this readme in addition to being named the same as their header. RDS objects or OGC geopackages are used as intermediate objects</p>
<section id="property-identification" class="level3">
<h3 class="anchored" data-anchor-id="property-identification">Property Identification</h3>
<p>This first script brings together the city and state property information datasets into a more easily usable table. The city and state real property datasets both have over 100 columns, much of it unneeded for this analysis. First, we trim the Baltimore dataset and then join it to the Maryland state set with the BLOCKLOT identifier in order to get the account ID for each property. Then, we join the CAMA datasets to get the land use description that we will utilize for categorization.</p>
</section>
<section id="sale-identification" class="level3">
<h3 class="anchored" data-anchor-id="sale-identification">Sale Identification</h3>
<p>This script focuses on the sales stored in the state real property dataset. We are first going to take those and pivot them to a long format in order to get tidy sales data. I was unsure how to approach the next two steps so I asked for chatGPT assistance. There is an elegant method for categorizing sales as vacant or non-vacant based on the date ranges provided in the VBN data with a join.</p>
<p>Next, we assign the assessed Base and Current Cycle values to the three years they represent. Maryland’s State Department of Assessments and Taxation works in a three-year cycle. For this, I also had ChatGPT help in writing a scripted that translated these ranges into long format.</p>
<p><a href="https://chatgpt.com/share/675f4586-a0cc-8010-8570-52b9856d12c8">Conversation with Assistance</a></p>
<p>The last two chunks of this script represent subjective choices on my part that affect the analysis. First, I filter out sales where the price is represented as $0 or the assessment is represented as $0. Zero dollar sales usually represent a transfer of property and have no bearing on its value, while the assessments are likely in error as every property has at least some value. Next, I group and combine sales that are the same date, price, block, and type of sale since these are likely to be grouped purchases. This is a data quality issue because the state fails to separate the price paid for individual proeperties when many are involved in a transfer.</p>
</section>
<section id="sale-analysis" class="level3">
<h3 class="anchored" data-anchor-id="sale-analysis">Sale Analysis</h3>
<p>The first two scripts do most of the heavy lifting aside from identification of sales and the calculation of the price ratio. This script brings the intermediate tables together to label the sale with a land use type. We classify properties with the NO_IMPRV marker from the Baltimore Real Property data and with no land use classification from the state CAMA data as unimproved sales. Any sales labeled vacant by the previous script are identified as vacant. Last, any properties labeled AUTO or WAREHOUSE are likely underperforming properties. Anything else is classified as a regular sale.</p>
<p>The price ratio is determined as the Assessed Value at the time of sale divided by the price of the sale. So if it’s over 1, the property is overassessed and under 1 is underassessed. The second part of this script splits and summarises the sales, aggregating them by neighborhood and identifier.</p>
</section>
</section>
<section id="visualization-scripts" class="level2">
<h2 class="anchored" data-anchor-id="visualization-scripts">Visualization Scripts</h2>
<p>Frustratingly, after the analysis was completed, we arrive at a point showing limited interesting insight. The lack of historical assessments in the public-facing data in addition to the difficulty of identifying sales where a home might have been substantially renovated before make the data on vacant sales quite dirty. With the intended deadline for my project and my grade dependent on submission, I am satisfied with the work done and always love representing Baltimore in map form even if it’s not so elegant. I hope that I will be able to continue this work in the coming years.</p>
<section id="sale-density-dotplot" class="level3">
<h3 class="anchored" data-anchor-id="sale-density-dotplot">Sale density dotplot</h3>
<p>I like using this visualization first because it shows that Baltimore has robust property sales despite the misconceptions about the state of the city. It also shows the scale of the issue being dealt with, which is that there are still a lot of vacant property to be dealt with.</p>
<section id="all-property-sales" class="level4">
<h4 class="anchored" data-anchor-id="all-property-sales">All Property Sales</h4>
<p><img src="Images/rdeck_dotplot.png" class="img-fluid" alt="All Sales"> #### Vacant, Unimproved and Underperforming only</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/vacants_only_dotplot.png" class="img-fluid figure-img"></p>
<figcaption>Vacants Only</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="acknowledgements-and-related-projects" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements-and-related-projects">Acknowledgements and related projects</h2>
<p>This project was inspired by similar work being taken on elsewhere that investigates the myriad of ways local governments, inadvertently or not, punish those with less wealth, less income, or just a smaller business. My interest in these topics is thanks to <a href="https://www.strongtowns.org/">Strong Towns by Charles Marohn</a> and his work bringing attention to government’s weakened ability to do the basics. Further, companies like Urban3 and their <a href="https://www.justaccounting.org/">Just Accounting Project</a> have shown how this type of assessment bias can be systematic. Last, <a href="https://s3.us-east-2.amazonaws.com/propertytaxdata.uchicago.edu/nationwide_reports/web/Baltimore%20city_Maryland.html#5_who_is_over-assessed">Dr.&nbsp;Christopher Berry’s project</a> on this type of assessment bias in Baltimore showed how we need to pursue better policy solutions at home.</p>
</section>
<section id="who-am-i-and-how-to-get-in-touch" class="level2">
<h2 class="anchored" data-anchor-id="who-am-i-and-how-to-get-in-touch">Who am I and how to get in touch</h2>
<p>My name is Joshua Spokes, I am a GIS Analyst with the City of Baltimore’s Department of Public Works and an enthusiast property tax nerd. This is an extension of my project looking at property values in southeast Baltimore (https://github.com/brokenspokes/Southeast_Patterson) and exploring how property that is underutilized frequently gets a pass on their property tax bill. I will continue to build more analyses like this in the coming years as we work towards fairer assessments and taxation in our city and state.</p>
<p>The README should continue with an longer description (using sub-headings to break up text as needed).</p>
<p>For data analysis projects, here are a few key elements to consider including in your README:</p>
<ul>
<li>Creator: who are you and why did you make this project? How can people get in touch with you?</li>
<li></li>
<li>Files and organization: what are the scripts and files in your repository? How are they named and organized?</li>
<li>Usage: how can another user get your data and reproduce your analysis or code? Are there any restrictions on reuse?</li>
<li>Acknowledgements and related projects: What work is your project inspired by or building on?</li>
</ul>
<p>Please add a license to your repository and your README with <code>usethis::use_mit_license()</code> or another <a href="https://usethis.r-lib.org/reference/licenses.html">usethis license function</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use this to a MIT License to a project </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_mit_license</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Setting active project to
  "/Users/jspokes/Documents/R_Projects/Final_Project_Presentation".</code></pre>
</div>
</div>
<p>This template is a plain Markdown file. You can alternatively create a README using a RMarkdown file or a Quarto document that you render to a <a href="https://quarto.org/docs/output-formats/gfm.html">GitHub Flavored Markdown</a> (GFM) document.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use quarto to render a qmd README file</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>quarto<span class="sc">::</span><span class="fu">quarto_render</span>(<span class="st">"README.qmd"</span>, <span class="st">"gfm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See <a href="https://data.research.cornell.edu/data-management/sharing/readme/">Guide to writing “readme” style metadata</a> for more information on documenting reusable data publications.</p>
<p>For more general advice, take a look at <a href="https://www.makeareadme.com/">Make a README</a>.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>